# Hostile ML Systems Audit

**Auditor:** Antigravity (Cortex AI)
**Date:** 2026-01-26
**Target:** Full Codebase (Data, Models, Training, Eval)

---

## Global Invariants (Claimed vs Reality)

| Invariant Claim | Verification Status | Reality |
|---|---|---|
| **Tensor Space:** Model outputs are physical units. | **VERIFIED** | `HybridScaledOutput` enforces manual scaling to `[-500, 500]` etc. |
| **Scaling Authority:** Trainer handles scaling transparently. | **BROKEN** | Trainer & Eval scripts actively fight the model by re-scaling already-scaled outputs (Double Denormalization). |
| **Loss Space:** Losses compare Apple-to-Apples. | **MIXED** | `WeightedStandardizedLoss` is correct. `Naive5ParamMSELoss` compares `Physical` vs `Normalized` (Critical Failure). |
| **Config Truth:** `standardize_outputs` controls data, not model. | **AMBIGUOUS** | Flag triggers normalization in Data/Loss, but erroneously triggers **denormalization** in Viz/Eval. |

---

## Section 1: Data & Targets

### 1.1 Raw Data Assumptions
*   **Source:** `src/data/loaders/simulation.py`
*   **Units:** `xc, yc, S` are generated in **Microns**.
    *   Evidence: `x_coords = np.linspace(xc - S/2...)`. `S` matches `xc` scale directly.
*   **Consistency:** Data generation uses `focal_length=100`, `wavelength=0.532` defaults.
*   **Risk:** `generate_grid_dataset` creates data on CPU. `OnTheFlyDataset` creates on CPU.
    *   **Verdict:** **SAFE**. Logic matches physical intuition.

### 1.2 Dataset Classes
*   `OnTheFlyDataset` / `GridDataset`:
    *   **Return:** `(Input, Target)` pair.
    *   **Space:** Targets are **Raw Physical Values**.
    *   **Normalization:** **NONE** happens in Dataset.
    *   **Authority:** Normalization is deferred to `Trainer` (for Loss) or `Model` (for Architecture).
    *   **Verdict:** **SAFE** (Clean contract).

---

## Section 2: Normalization & Scaling Contracts

| Tensor | Location | Space In | Space Out | Authority | Status |
|---|---|---|---|---|---|
| **Loader Target** | `Dataset` | N/A | Physical | `simulation.py` | ✅ |
| **Model Output** | `FNOResNet18` | Latent | Physical | `HybridScaledOutput` | ✅ |
| **Loss Input (Pred)** | `WeightedLoss` | Physical | Normalized | `ParameterNormalizer` | ✅ |
| **Loss Input (Target)** | `WeightedLoss` | Physical | Normalized | `ParameterNormalizer` | ✅ |
| **Viz Input** | `Trainer.py` | Physical | **Exploded** | `Trainer` (Legacy) | ❌ FIXED |
| **Eval Input** | `evaluate.py` | Physical | **Exploded** | `evaluate.py` | ❌ **CRITICAL** |

**Violation:** `evaluate.py` applies `denormalize_tensor` to `pred` which is *already* physical, multiplying values by $\sigma \approx 500$.

---

## Section 3: Model Architectures

### 3.1 Output Semantics
*   **Component:** `src/models/layers/scaled_output.py` (`HybridScaledOutput`).
*   **Logic:**
    *   `xc = center + half_range * tanh(x)`
    *   `S = min + scale * sigmoid(x)`
*   **Guarantee:** Output is constrained to physical range (e.g., `[-500, 500]`).
*   **Dependency:** This layer is **hardcoded** in `FNOResNet18.__init__`.
*   **Conflict:** Config flag `standardize_outputs` is ignored by architecture but respected by downstream consumers, causing mismatch.

---

## Section 4: Loss Functions

### 4.1 WeightedStandardizedLoss (S09-S14)
*   **Logic:**
    ```python
    if self.normalizer:
        pred_norm = ...
        true_norm = ...
        diff = pred_norm - true_norm
    ```
*   **Verdict:** **CORRECT**. It adapts to the physical model output.

### 4.2 Naive5ParamMSELoss (Legacy)
*   **Logic:**
    ```python
    if self.normalizer:
        true_norm = normalize(true_params)
        loss = mse(pred_params, true_norm)
    ```
*   **Verdict:** **CATASTROPHIC FAILURE**.
    *   Compares `Pred (100.0)` vs `Target (0.2)`.
    *   Model will be forced to output ~0.2 (Physical).
    *   **Recommendation:** Delete this class immediately.

---

## Section 5: Trainer & Training Loop

*   **Flow:** `Batch -> Model -> PhysicalOutput -> Loss(Norm) -> Gradient`.
*   **Logging:** `total_loss` is logged.
*   **Verdict:** **SAFE** (after Trainer fix). The training loop itself respects the contracts.

---

## Section 6: Validation & Evaluation

### 6.1 Validation Loop
*   Uses `criterion` (Loss function).
*   Since `criterion` handles logic correctly, validation loss is correct.

---

## Section 7: Visualization & Debug Plots

### 7.1 Trainer Visualization (Patched)
*   I manually removed the double-denormalization logic in `trainer.py` (Steps 950-960).
*   **Status:** **SAFE**.

### 7.2 Scripts/Evaluate.py (Unpatched)
*   **Logic:**
    ```python
    if config['standardize_outputs']:
        predictions = normalizer.denormalize_tensor(predictions)
    ```
*   **Problem:** `predictions` came from `model(inputs)`, which is Physical.
*   **Status:** **DANGEROUS**. Any results generated by `evaluate.py` for S09-S14 will be creating false alarms of model failure.

---

## Section 10: Failure Mode Inventory

1.  **Double Denormalization (Evaluation):**
    *   **Likelihood:** 100% (if script used).
    *   **Impact:** User believes model diverges.
    *   **Fix:** Patch `evaluate.py`.

2.  **Legacy Loss Functions:**
    *   **Likelihood:** Low (unless config changed to `naive_5param`).
    *   **Impact:** Silent training failure (convergence to zero).
    *   **Fix:** Deprecate/Delete `Naive5ParamMSELoss`.

3.  **Range Mismatch:**
    *   If `data.yaml` ranges differ from `fno_resnet18.py` hardcoded defaults.
    *   **Current:** `fno_resnet18.py` defaults to `(-500, 500)`. `data.yaml` usually matches.
    *   **Risk:** `FNOResNet18` takes range args but Factory might not pass them from Config.
    *   **Check:** Factory `get_model` passes `**kwargs`. Ensure config ranges are passed.

---

## Section 11: Hardening Recommendations

1.  **Immediate:** Patch `scripts/evaluate.py` to remove denormalization logic.
2.  **Structural:** Add a `output_space` attribute to Model classes.
    *   `model.output_space = "physical"`
    *   Trainer checks `model.output_space` before deciding to denormalize.
3.  **Cleanup:** Remove `Naive5ParamMSELoss` or rewrite it to normalize `pred` as well.
4.  **Config:** Explicitly pass parameter ranges to Model `__init__` in `factory.py` to ensure Model Ranges == Data Ranges.

**End of Audit.**
